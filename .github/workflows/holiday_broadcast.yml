name: Xiaoyun Holiday Broadcast

on:
  schedule:
    # é€™æ˜¯æˆ‘å€‘çš„ã€Œç¯€æ—¥é¬§é˜ã€åˆ—è¡¨ã€‚ä½¿ç”¨ UTC æ™‚é–“ã€‚
    # (UTC+8 çš„ æ—©ä¸Š 9:00 æ˜¯ UTC 01:00)
    
    # --- å›ºå®šæ—¥æœŸç¯€æ—¥ ---
    # è²“ä¹‹æ—¥ (æ¯å¹´ 2æœˆ22æ—¥)
    - cron: '0 1 22 2 *' 
    # è–èª•ç¯€ (æ¯å¹´ 12æœˆ25æ—¥)
    - cron: '0 1 25 12 *'
    # è·¨å¹´å¤œ (æ¯å¹´ 12æœˆ31æ—¥)
    - cron: '0 1 31 12 *'
    # æ–°å¹´ç¬¬ä¸€å¤© (æ¯å¹´ 1æœˆ1æ—¥)
    - cron: '0 1 1 1 *'
    
    # --- æµ®å‹•æ—¥æœŸç¯€æ—¥ (ç¯„ä¾‹ - æ¯å¹´éœ€æ‰‹å‹•æ›´æ–°) ---
    # 2025 è¾²æ›†é™¤å¤• (2025å¹´1æœˆ28æ—¥)
    - cron: '0 1 28 1 *'

  workflow_dispatch:
    inputs:
      event_override:
        description: 'æ‰‹å‹•æ¸¬è©¦ï¼šè¼¸å…¥ç¯€æ—¥åç¨±'
        required: true
        default: 'ä¸€å€‹å¿«æ¨‚çš„æ¸¬è©¦æ—¥'

jobs:
  broadcast-holiday-message:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Determine Event and Run Script
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          EVENT_NAME_TO_RUN=""
          # æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹å‹•è§¸ç™¼
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            EVENT_NAME_TO_RUN="${{ github.event.inputs.event_override }}"
          else
            # æ ¹æ“šç•¶å‰ UTC æ—¥æœŸåˆ¤æ–·ç¯€æ—¥
            UTC_DATE=$(date -u +'%m-%d')
            UTC_FULL_DATE=$(date -u +'%Y-%m-%d')
            
            if [[ "$UTC_DATE" == '02-22' ]]; then
              EVENT_NAME_TO_RUN="è²“ä¹‹æ—¥"
            elif [[ "$UTC_DATE" == '12-25' ]]; then
              EVENT_NAME_TO_RUN="è–èª•ç¯€"
            elif [[ "$UTC_DATE" == '12-31' ]]; then
              EVENT_NAME_TO_RUN="è·¨å¹´å¤œ"
            elif [[ "$UTC_DATE" == '01-01' ]]; then
              EVENT_NAME_TO_RUN="å…ƒæ—¦æ–°å¹´"
            elif [[ "$UTC_FULL_DATE" == '2025-01-28' ]]; then
              EVENT_NAME_TO_RUN="è¾²æ›†é™¤å¤•å¤œ"
            fi
          fi

          if [[ -n "$EVENT_NAME_TO_RUN" ]]; then
            echo "ğŸ‰ Detected event: $EVENT_NAME_TO_RUN"
            # å°‡äº‹ä»¶åç¨±ä½œç‚ºç’°å¢ƒè®Šæ•¸å‚³éçµ¦ Python è…³æœ¬
            EVENT_NAME="$EVENT_NAME_TO_RUN" python holiday_broadcast.py
          else
            echo "No scheduled event for today. Skipping."
          fi
